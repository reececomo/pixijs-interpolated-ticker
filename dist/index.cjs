"use strict";class Emits{constructor(){this._listeners={}}on(t,e){var i,s;return(null!==(i=(s=this._listeners)[t])&&void 0!==i?i:s[t]=[]).push(e),this}off(t,e){var i,s;return this._listeners[t]=(null!==(i=(s=this._listeners)[t])&&void 0!==i?i:s[t]=[]).filter((t=>t!==e)),this}emit(t,...e){var i,s;for(const a of null!==(i=(s=this._listeners)[t])&&void 0!==i?i:s[t]=[])a(...e)}}function fpsCounter(t){const e=t.onChange,i=t.intervalMS,s=t.precision;let a=0,n=0,r=0;return t=>{if(a+=t,n+=1,a<i)return;const o=Math.round(1e3*n/a/s)*s;n=0,a=0,r!==o&&(e(o),r=o)}}class ContainerInterpolator{constructor({capacity:t=256,maxCapacity:e=4096,maxDeltaPosition:i=100,maxDeltaScale:s=1,maxDeltaRotation:a=Math.PI/2,maxDeltaAlpha:n=.5}={}){this._count=0,this._prevCount=0,this._maxCapacity=e,this._maxDeltaAlpha=n,this._maxDeltaPosition=i,this._maxDeltaRotation=a,this._maxDeltaScale=s,this._capacity=t,this._containers=new Array(this._capacity);const r=this._capacity*Float32Array.BYTES_PER_ELEMENT,o=2*r*6;this._buffer=new ArrayBuffer(o);let h=0;const allocate=()=>{const t=r*h++;return new Float32Array(this._buffer,t,this._capacity)};this._startX=allocate(),this._startY=allocate(),this._startRotation=allocate(),this._startScaleX=allocate(),this._startScaleY=allocate(),this._startAlpha=allocate(),this._endX=allocate(),this._endY=allocate(),this._endRotation=allocate(),this._endScaleX=allocate(),this._endScaleY=allocate(),this._endAlpha=allocate()}capture(t){const e=this._containers,i=this._startX,s=this._startY,a=this._startRotation,n=this._startScaleX,r=this._startScaleY,o=this._startAlpha;this._count=0;const captureContainers=(t,h)=>{var l,_,c;if(t.destroyed)return;const d=null!==(l=t.isInterpolated)&&void 0!==l?l:t.visible,p=null!==(_=t.hasInterpolatedChildren)&&void 0!==_?_:d;if(d){null!==(c=t.isInterpolated)&&void 0!==c||(t.isInterpolated=!0);const h=this._count++;if(h>=this._capacity){if(this._capacity>=this._maxCapacity)return void console.error("[ContainerInterpolator] exceeded buffer capacity:",h);this._resizeCapacity(2*this._capacity)}e[h]=t,i[h]=t.position._x,s[h]=t.position._y,n[h]=t.scale._x,r[h]=t.scale._y,a[h]=t.rotation,o[h]=t.alpha}if(p){const e=t.children;for(let t=0;t<e.length;t++)captureContainers(e[t])}};captureContainers(t);for(let t=this._count;t<this._prevCount;t++)this._containers[t]=void 0;this._prevCount=this._count}blend(t){t=Math.min(1,Math.max(0,t));const e=this._maxDeltaPosition,i=this._maxDeltaScale,s=this._maxDeltaAlpha,a=this._maxDeltaRotation,n=this._containers,r=this._startX,o=this._startY,h=this._startRotation,l=this._startScaleX,_=this._startScaleY,c=this._startAlpha,d=this._endX,p=this._endY,u=this._endRotation,f=this._endScaleX,S=this._endScaleY,m=this._endAlpha;let v,M,x,y,R,I,A;for(let Y=0;Y<this._count;Y++)v=n[Y],void 0===v||v.destroyed||(M=(d[Y]=v.position._x)-r[Y],x=(p[Y]=v.position._y)-o[Y],R=(f[Y]=v.scale._x)-l[Y],I=(S[Y]=v.scale._y)-_[Y],y=(u[Y]=v.rotation)-h[Y],A=(m[Y]=v.alpha)-c[Y],(0!==M||0!==x)&&Math.abs(M)<=e&&Math.abs(x)<=e&&v.position.set(r[Y]+M*t,o[Y]+x*t),(0!==R||0!==I)&&Math.abs(R)<=i&&Math.abs(I)<=i&&v.scale.set(l[Y]+R*t,_[Y]+I*t),0!==y&&Math.abs(y)<=a&&(v.rotation=h[Y]+y*t),0!==A&&Math.abs(A)<=s&&(v.alpha=c[Y]+A*t))}unblend(){const t=this._containers,e=this._endX,i=this._endY,s=this._endRotation,a=this._endScaleX,n=this._endScaleY,r=this._endAlpha;let o,h,l,_,c,d,p;for(let u=0;u<this._count;u++)o=t[u],void 0===o||o.destroyed||(h=o.position._x-e[u],l=o.position._y-i[u],c=o.scale._x-a[u],d=o.scale._y-n[u],_=o.rotation-s[u],p=o.alpha-r[u],0===h&&0===l||o.position.set(e[u],i[u]),0===c&&0===d||o.scale.set(a[u],n[u]),0!==_&&(o.rotation=s[u]),0!==p&&(o.alpha=r[u]))}_resizeCapacity(t){const e=(t=Math.min(t,this._maxCapacity))*Float32Array.BYTES_PER_ELEMENT,i=new ArrayBuffer(2*e*6);let s=0;const allocateFrom=a=>{const n=e*s++,r=new Float32Array(i,n,t);return r.set(a),r};this._startX=allocateFrom(this._startX),this._startY=allocateFrom(this._startY),this._startRotation=allocateFrom(this._startRotation),this._startScaleX=allocateFrom(this._startScaleX),this._startScaleY=allocateFrom(this._startScaleY),this._startAlpha=allocateFrom(this._startAlpha),this._endX=allocateFrom(this._endX),this._endY=allocateFrom(this._endY),this._endRotation=allocateFrom(this._endRotation),this._endScaleX=allocateFrom(this._endScaleX),this._endScaleY=allocateFrom(this._endScaleY),this._endAlpha=allocateFrom(this._endAlpha),this._buffer=i,this._capacity=t}}const EMPTY=()=>{};exports.ContainerInterpolator=ContainerInterpolator,exports.InterpolatedTicker=class InterpolatedTicker extends Emits{constructor(t){var e,i,s,a,n,r,o;super(),this.speed=1,this._renderFPS=0,this._minRenderMS=0,this.fixedDeltaMS=null!==(e=t.fixedDeltaMS)&&void 0!==e?e:1e3/60,this.interpolation=null===(i=t.interpolation)||void 0===i||i,this._renderer=t.renderer,this._stage=t.stage,this._interpolationOptions=t.interpolationOptions,this._maxFrameTimeMS=null!==(s=t.maxFrameTimeMS)&&void 0!==s?s:3*this.fixedDeltaMS,this._renderIntervalToleranceMS=null!==(a=t.renderIntervalToleranceMS)&&void 0!==a?a:7,this._fpsIntervalMS=null!==(n=t.fpsIntervalMS)&&void 0!==n?n:1e3,this._fpsPrecision=null!==(r=t.fpsPrecision)&&void 0!==r?r:1,this.renderFPS=null!==(o=t.renderFPS)&&void 0!==o?o:0}get started(){return null!=this._rafRequestId}get renderFPS(){return this._renderFPS}set renderFPS(t){if(t=Math.max(t,0),this._renderFPS=t,t){const e=1e3/t-this._renderIntervalToleranceMS;this._minRenderMS=e}else this._minRenderMS=0}start(t){var e,i;this.started&&this.stop();const s=fpsCounter({onChange:t=>this.emit("devicefps",t),intervalMS:this._fpsIntervalMS,precision:this._fpsPrecision}),a=fpsCounter({onChange:t=>this.emit("fps",t),intervalMS:this._fpsIntervalMS,precision:this._fpsPrecision}),n=t.update,r=null!==(e=t.prepareRender)&&void 0!==e?e:EMPTY,o=null!==(i=t.render)&&void 0!==i?i:EMPTY,h=new ContainerInterpolator(this._interpolationOptions),l=this._renderer,_=this._stage,c=this.fixedDeltaMS,d=performance.now();let p=d,u=d,f=0,S=!1,m=1;const frameHandler=t=>{this._rafRequestId=requestAnimationFrame(frameHandler);const e=t-p;for(p=t,s(e),f+=this.speed*Math.min(e,this._maxFrameTimeMS);f>=c;)S=this.interpolation,S&&h.capture(_),n(c),f-=c;const i=performance.now(),d=i-u;d>=this._minRenderMS&&(u=i,m=S?f/c:1,r(d),S&&h.blend(m),o(d,m),l.render(_),a(d),S&&h.unblend())};return this._rafRequestId=requestAnimationFrame(frameHandler),this}stop(){null!=this._rafRequestId&&(cancelAnimationFrame(this._rafRequestId),this._rafRequestId=void 0)}};
//# sourceMappingURL=index.cjs.map
